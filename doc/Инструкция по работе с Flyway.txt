Инструкция по миграции базы данных с flyway:


отправная точка:
На вашем компьютере установлен postgresql версии 10
 - если у Вас версия 11 и выше то будут некоторые проблемы в интеграции flyway с СУБД т.к. с выходом 11 версии были исключены некоторые системные таблицы, которыми пользуется flyway.
 У меня на 11 версии были проблемы по выполнению команды clean (очистка базы данных).
 - Вместе с тем более старые версии тоже не рекомендую использовать, т.к. версим flyway, спользуемая в нашем проекте тоже может работать некорректно

* версию postgresql Вы можете скачать по адресу https://www.postgresql.org/download/ выбрав свою операционную систему
* Я нажимал Windows/Download the installer/ и для своей версии Windows x86-64 выбрал download версии PostgreSql 10 (на момент моего скачивания была версия 10.8, когда писал эту инструкцию версия стала 10.9)
перед установкой рекомендую зайти в Панель управления/Администрирование/службы:

 - проверить, что службы postgresql у вас на компе нет,
 - если есть postgresql версии отличной от 10 - остановить и поставить тип запуска - Вручную.
 - Соответственно если уже стоит версия postgresql 10 и работает то установка не требуется. Убедитесь, что тип запуска Автоматически (это означает, что служба запускается сразу после запуска Windows автоматически).

устанавливайте, соглашаясь с утановщиком далее-далее. При задать пвроль можете какой хотите. Главное не забыть потом)))

Итак. У нас стоит PostgreSQL 10
0. проверьте, что все сделали правильно:
 - зайти в Панель управления/Администрирование/службы.
 - найдите postgresql 10 и убедитесь, что служба работает.
1. В Intellij Idea справа зайдите во вклядку Database. Если нет вкладки: View - Tool Windows - Database
2. Нажимаете зеленый +
3. Datasource/PostgreSql
4. Вводите следующие данные host: localhost ; Database: postgres ; User: postgres; Password: тот, который был создан при установке.
5. Нажимаете Test Connection и видите приятным зеленым цветом Successful
6. Отлично. Нажимаем OK

---FLYWAY---
0. Для миграции базы данных должна быть создана пустая база данных, создаем ее:
 - Правым щелчком мыши нажимаем на созданную БД postgresql
 - Выбираем Open Console
 - Из папки resources/db нашего проекта открываем файлик sql.sql и копируем из него все содержимое (2 скрипта) в открывшуюся консоль БД:
    * первый скрипт - это создание пользователя, который будет владельцем нашей БД. Через него и будет работать flyway;
    * второй скрипт - собственно создание нашей БД.
1. Заходите снова во вкладку Database. Если нет вкладки: View - Tool Windows - Database
2. Делаете аналогичные добавлению бызы postgres действия по добавлению в Intellij Idea нашей бызы:
    - Нажимаете зеленый +
    - Datasource/PostgreSql
    - Вводите следующие данные host: localhost ; Database: musicportal; User: musicportal; Password: musicportal
    - Нажимаете Test Connection и видите приятным зеленым цветом Successful
    - Отлично. Нажимаем OK
3. Идем во вкладку maven - Plugins
4. Выбираем flyway:clean - это очистка базы данных, удаление всех таблиц с их содержанием, связей, зависимостей и т.д. то есть после успешного выполнения команды Clean база становится абсолютно пустой. Как после создания.
5. Выбираем flyway:migrate - собственно миграция базы данных из файлов SQL, расположенных в resources/db/migration
6. Миграция должна быть выполнена успешно.

ВАЖНО!!!
1. Файлы, находящиеся в папке db/migration обязательно должны быть именованы по следующим правилам:
V{номер}__имя.sql
Обратите внимание, после V{номер}, два нижних подчеркивания.
Пример V1__CREATE_MAIN_TABLES_AUTO_GENERATED.sql

2. При вводе команд DDL - команды по изменению структуры базы данных изменяется версия БД, которую контролирует flyway
Таким образом, если вы самостоятельно или программно измените структуру базы данных минуя flyway произойдет конфликт версий, при котором миграция баз данных станет невозможной.









